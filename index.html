<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Engine Car Pro - Système Sonore Avancé</title>
    <link rel="manifest" href="./manifest.webmanifest">
    <meta name="theme-color" content="#000000">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 50%, #0c0c0c 100%);
            color: #fafafa;
            min-height: 100vh;
            padding: 1rem;
            overflow-y: auto;
            transition: background 0.5s;
        }
        
        .theme-light {
            background: linear-gradient(135deg, #f0f0f0 0%, #ffffff 50%, #f0f0f0 100%);
            color: #333;
        }
        
        @media (max-height: 700px) {
            body {
                align-items: flex-start;
            }
        }
        
        .container {
            width: 100%;
            max-width: 600px;
            text-align: center;
        }
        
        .header {
            margin-bottom: 1.8rem;
            position: relative;
        }
        
        h1.title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.4rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient 3s ease infinite;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .subtitle {
            color: #888;
            margin-bottom: 1.2rem;
            font-size: 1.05rem;
        }
        
        button {
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .stats-bar {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        
        .stats-item {
            padding: 0.45rem 0.9rem;
            font-size: 0.85rem;
        }
        
        .mode-selector,
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        
        .mode-button,
        .control-button {
            padding: 0.7rem 1rem;
            border: 2px solid #333;
            border-radius: 15px;
            background: linear-gradient(135deg, #2d2d2d, #1a1a1a);
            color: #fafafa;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .mode-button:hover,
        .control-button:hover {
            transform: translateY(-2px);
            border-color: #4ecdc4;
        }
        
        .mode-button.active,
        .control-button.active {
            background: linear-gradient(135deg, #4ecdc4, #45b7d1);
            border-color: #4ecdc4;
        }
        
        .vehicle-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 1.8rem;
        }
        
        .vehicle-button {
            padding: 1rem;
            border-radius: 15px;
            border: 2px solid #333;
            background: linear-gradient(135deg, #2d2d2d, #1a1a1a);
            color: #fafafa;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .vehicle-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        
        .vehicle-button:hover::before {
            left: 100%;
        }
        
        .vehicle-button:hover {
            transform: translateY(-3px);
            border-color: #4ecdc4;
            box-shadow: 0 8px 16px rgba(78, 205, 196, 0.3);
        }
        
        .vehicle-button.active {
            background: linear-gradient(135deg, #4ecdc4, #45b7d1);
            border-color: #4ecdc4;
            transform: scale(1.03);
        }
        
        .vehicle-icon {
            font-size: 1.4rem;
            margin-bottom: 0.3rem;
            display: block;
        }
        
        .vehicle-name {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 0.2rem;
        }
        
        .vehicle-specs {
            font-size: 0.7rem;
            color: #aaa;
        }
        
        .dashboard {
            padding: 1.8rem 1.5rem;
            margin-bottom: 1.6rem;
            border: 1px solid #333;
            position: relative;
        }
        
        .gauges {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.4rem;
        }
        
        .gauge {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            position: relative;
        }
        
        .g-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: conic-gradient(from 0deg, #333 0deg, #4ecdc4 0deg, #333 0deg);
        }
        
        .g-inner {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #1a1a1a;
        }
        
        .g-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #4ecdc4;
        }
        
        .g-label {
            font-size: 0.78rem;
            color: #888;
        }
        
        .gear-display {
            text-align: center;
            margin-bottom: 1.2rem;
        }
        
        .gear-number {
            font-size: 3rem;
            font-weight: 700;
            color: #4ecdc4;
            text-shadow: 0 0 18px rgba(78, 205, 196, 0.5);
        }
        
        .gear-label {
            color: #888;
            margin-top: 0.5rem;
        }
        
        .controls {
            margin-top: 1rem;
        }
        
        .control-slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }
        
        .control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
        }
        
        .visualizer {
            width: 100%;
            height: 80px;
            border-radius: 10px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 1.2rem 0;
        }
        
        .sound-wave {
            width: 4px;
            margin: 0 2px;
            border-radius: 2px;
            background: linear-gradient(to top, #4ecdc4, #45b7d1);
            transition: height 0.1s;
        }
        
        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #4ecdc4;
            border-radius: 50%;
            opacity: 0.8;
            animation: float 2s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); opacity: 0.8; }
            50% { transform: translateY(-20px) scale(1.2); opacity: 1; }
        }
        
        .session-info {
            padding: 1.2rem;
            margin: 1.2rem 0;
        }
        
        .session-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .session-stat {
            text-align: center;
        }
        
        .session-stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4ecdc4;
        }
        
        .session-stat-label {
            font-size: 0.8rem;
            color: #888;
        }
        
        .challenge-panel {
            padding: 1.2rem;
            margin: 1.2rem 0;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(78, 205, 196, 0.2));
            border: 1px solid rgba(78, 205, 196, 0.3);
            display: none;
        }
        
        .challenge-title {
            font-weight: bold;
            color: #4ecdc4;
            margin-bottom: 0.5rem;
        }
        
        .challenge-progress {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        
        .challenge-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            padding: 2rem;
            border-radius: 20px;
            border: 1px solid #333;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4ecdc4, #45b7d1);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        /* Nouveaux styles */
        .weather-info {
            padding: 0.7rem;
            border-radius: 15px;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }
        
        .manual-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .gear-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .sound-effects {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .sound-effect-btn {
            padding: 0.5rem;
            border-radius: 10px;
            min-width: 80px;
        }
        
        .help-icon {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .help-modal {
            max-width: 500px;
            text-align: left;
        }
        
        .help-modal p {
            margin: 0.8rem 0;
            line-height: 1.5;
        }
        
        .help-modal h4 {
            margin-top: 1.2rem;
            color: #4ecdc4;
        }
        
        .modal-section {
            margin: 1.5rem 0;
        }
        
        .modal-section h3 {
            color: #4ecdc4;
            margin-bottom: 0.8rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 0.5rem;
        }
        
        .sound-effect-btn.active {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
        }
        
        @media (max-width: 480px) {
            h1.title {
                font-size: 2rem;
            }
            
            .gauges {
                grid-template-columns: 1fr;
            }
            
            .gauge {
                width: 100px;
                height: 100px;
            }
            
            .vehicle-selector {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .manual-controls {
                gap: 0.5rem;
            }
            
            .gear-btn {
                width: 40px;
                height: 40px;
            }
        }
        
        .theme-light .glass {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(0, 0, 0, 0.05);
        }
        
        .theme-light .mode-button,
        .theme-light .control-button,
        .theme-light .vehicle-button {
            background: linear-gradient(135deg, #e0e0e0, #f5f5f5);
            color: #333;
            border-color: #ccc;
        }
        
        .theme-light .g-inner {
            background: #f0f0f0;
        }
        
        .theme-light .sound-effect-btn {
            background: #f0f0f0;
            color: #333;
        }
        
        .theme-light .help-icon {
            background: rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="help-icon" id="helpButton">?</div>
            <h1 class="title">🏎️ Sound Engine Car Pro</h1>
            <p class="subtitle">Système sonore avancé pour une expérience réaliste</p>
            
            <div class="stats-bar">
                <div class="stats-item glass">🏆 <span id="totalDistance">0</span> km</div>
                <div class="stats-item glass">⏱️ <span id="totalTime">0</span> min</div>
                <div class="stats-item glass">🔥 <span id="streakDays">0</span> jours</div>
            </div>
        </header>
        
        <div class="weather-info glass" id="weatherInfo">🌤️ Localisation détectée - 22°C Ensoleillé</div>
        
        <div class="mode-selector">
            <button class="mode-button active" data-mode="static">🔧 Stationnaire</button>
            <button class="mode-button" data-mode="driving">🚗 Conduite</button>
            <button class="mode-button" data-mode="circuit">🏁 Circuit</button>
            <button class="mode-button" data-mode="challenge">🎯 Défis</button>
        </div>
        
        <div class="vehicle-selector" id="vehicleSelector">
            <!-- Les véhicules seront générés par JavaScript -->
        </div>
        
        <section class="dashboard glass">
            <div class="gauges">
                <div class="gauge">
                    <div class="g-circle" id="rpmGauge">
                        <div class="g-inner">
                            <div class="g-value" id="rpmValue">0</div>
                            <div class="g-label">RPM</div>
                        </div>
                    </div>
                </div>
                <div class="gauge">
                    <div class="g-circle" id="speedGauge">
                        <div class="g-inner">
                            <div class="g-value" id="speedValue">0</div>
                            <div class="g-label">km/h</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="gear-display">
                <div class="gear-number" id="gearDisplay">N</div>
                <div class="gear-label">Vitesse</div>
            </div>
            
            <div class="controls">
                <input type="range" class="control-slider" id="throttleSlider" min="0" max="100" value="0">
                <div style="margin: 0.5rem 0; color: #888;">Accélérateur: <span id="throttleValue">0</span>%</div>
            </div>
            
            <!-- Nouveaux contrôles manuels -->
            <div class="manual-controls" id="manualControls">
                <button class="gear-btn glass" id="gearDown">⬇️</button>
                <button class="gear-btn glass" id="gearUp">⬆️</button>
            </div>
            
            <!-- Nouveaux effets sonores -->
            <div class="sound-effects">
                <button class="sound-effect-btn glass" data-effect="turbo">Turbo</button>
                <button class="sound-effect-btn glass" data-effect="exhaust">Échappement</button>
                <button class="sound-effect-btn glass" data-effect="ignition">Démarrage</button>
                <button class="sound-effect-btn glass" data-effect="horn">Klaxon</button>
            </div>
        </section>
        
        <div class="visualizer" id="visualizer">
            <!-- Les vagues sonores seront générées par JavaScript -->
        </div>
        
        <div class="control-panel">
            <button class="control-button" id="audioToggle">
                <span>🔈</span>
                <span>Audio</span>
            </button>
            <button class="control-button" id="engineToggle">
                <span>▶️</span>
                <span>Moteur</span>
            </button>
            <button class="control-button" id="recordToggle">
                <span>📹</span>
                <span>Rec</span>
            </button>
            <button class="control-button" id="themeToggle">
                <span>🌓</span>
                <span>Thème</span>
            </button>
            <button class="control-button" id="shareButton">
                <span>📱</span>
                <span>Partager</span>
            </button>
            <button class="control-button" id="settingsButton">
                <span>⚙️</span>
                <span>Réglages</span>
            </button>
        </div>
        
        <section class="session-info glass" id="sessionInfo">
            <h3>Session en cours</h3>
            <div class="session-stats">
                <div class="session-stat">
                    <div class="session-stat-value" id="sessionTime">0:00</div>
                    <div class="session-stat-label">Temps</div>
                </div>
                <div class="session-stat">
                    <div class="session-stat-value" id="sessionDistance">0.0</div>
                    <div class="session-stat-label">km</div>
                </div>
                <div class="session-stat">
                    <div class="session-stat-value" id="sessionMaxSpeed">0</div>
                    <div class="session-stat-label">Vmax</div>
                </div>
                <div class="session-stat">
                    <div class="session-stat-value" id="sessionAvgSpeed">0</div>
                    <div class="session-stat-label">Vmoy</div>
                </div>
            </div>
        </section>
        
        <section class="challenge-panel glass" id="challengePanel">
            <div class="challenge-title" id="challengeTitle">Défi: Vitesse constante</div>
            <div class="challenge-progress">
                <div class="challenge-progress-bar" id="challengeProgressBar"></div>
            </div>
            <div id="challengeDescription">Maintenez 60 km/h pendant 30 secondes</div>
        </section>
    </div>
    
    <div class="modal" id="settingsModal">
        <div class="modal-content glass">
            <button class="close-modal" id="closeSettings">&times;</button>
            <h3>Réglages</h3>
            <div class="modal-section">
                <h4>Audio</h4>
                <div style="margin: 1rem 0;">
                    <label>Volume principal: <span id="masterVolumeLabel">50%</span></label>
                    <input type="range" id="masterVolumeSlider" min="0" max="100" value="50" class="control-slider">
                </div>
                <div style="margin: 1rem 0;">
                    <label>Volume des effets: <span id="effectsVolumeLabel">70%</span></label>
                    <input type="range" id="effectsVolumeSlider" min="0" max="100" value="70" class="control-slider">
                </div>
            </div>
            
            <div class="modal-section">
                <h4>Options</h4>
                <div style="margin: 1rem 0;">
                    <label>
                        <input type="checkbox" id="hapticFeedback"> Vibrations haptiques
                    </label>
                </div>
                <div style="margin: 1rem 0;">
                    <label>
                        <input type="checkbox" id="autoGear" checked> Boîte automatique
                    </label>
                </div>
                <div style="margin: 1rem 0;">
                    <label>
                        <input type="checkbox" id="geolocationEnabled" checked> Activer la géolocalisation
                    </label>
                </div>
                <div style="margin: 1rem 0;">
                    <label>
                        <input type="checkbox" id="showHelpTips" checked> Afficher les conseils
                    </label>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="helpModal">
        <div class="modal-content glass help-modal">
            <button class="close-modal" id="closeHelp">&times;</button>
            <h3>Aide - Sound Engine Car Pro</h3>
            
            <div class="modal-section">
                <h4>Comment utiliser l'application</h4>
                <p>1. Sélectionnez un véhicule dans la liste</p>
                <p>2. Réglez l'accélérateur avec le curseur</p>
                <p>3. Choisissez un mode de conduite</p>
                <p>4. Activez les effets sonores supplémentaires</p>
            </div>
            
            <div class="modal-section">
                <h4>Fonctionnalités</h4>
                <p><strong>🔧 Stationnaire</strong>: Simule le moteur au ralenti</p>
                <p><strong>🚗 Conduite</strong>: Utilise la géolocalisation pour la vitesse</p>
                <p><strong>🏁 Circuit</strong>: Mode de course avec accélération rapide</p>
                <p><strong>🎯 Défis</strong>: Réalisez des objectifs pour gagner des récompenses</p>
            </div>
            
            <div class="modal-section">
                <h4>Conseils</h4>
                <p>• Changez de thème pour adapter l'interface à vos préférences</p>
                <p>• Activez le mode boîte manuelle pour plus de réalisme</p>
                <p>• Partagez vos sessions avec vos amis</p>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // Configuration des véhicules
        const vehicles = {
            muscle: {
                icon: '🚗',
                name: 'Muscle Car',
                specs: 'V8 • 450cv • RWD',
                maxRpm: 7000,
                maxSpeed: 280,
                baseFreq: 80,
                freqFactor: 0.01,
                waveType: 'sawtooth',
                color: '#ff6b6b',
                soundEffects: ['ignition', 'exhaust']
            },
            f1: {
                icon: '🏎️',
                name: 'Formule 1',
                specs: 'V6T • 1000cv • AWD',
                maxRpm: 15000,
                maxSpeed: 350,
                baseFreq: 200,
                freqFactor: 0.02,
                waveType: 'square',
                color: '#45b7d1',
                soundEffects: ['turbo', 'ignition']
            },
            rally: {
                icon: '🚙',
                name: 'Rally',
                specs: '4cyl T • 300cv • AWD',
                maxRpm: 8500,
                maxSpeed: 200,
                baseFreq: 120,
                freqFactor: 0.015,
                waveType: 'sawtooth',
                color: '#ffd93d',
                soundEffects: ['exhaust', 'ignition']
            },
            hypercar: {
                icon: '⚡',
                name: 'Hypercar',
                specs: 'Hybride • 1500cv • AWD',
                maxRpm: 9000,
                maxSpeed: 400,
                baseFreq: 150,
                freqFactor: 0.018,
                waveType: 'sawtooth',
                color: '#ff6b6b',
                soundEffects: ['turbo', 'ignition']
            },
            truck: {
                icon: '🚛',
                name: 'Camion',
                specs: 'V12 • 600cv • 6x4',
                maxRpm: 5500,
                maxSpeed: 120,
                baseFreq: 60,
                freqFactor: 0.008,
                waveType: 'sawtooth',
                color: '#4ecdc4',
                soundEffects: ['horn', 'exhaust']
            },
            ev: {
                icon: '🔋',
                name: 'Électrique',
                specs: 'Électrique • 800cv • AWD',
                maxRpm: 20000,
                maxSpeed: 300,
                baseFreq: 300,
                freqFactor: 0.025,
                waveType: 'sine',
                color: '#4ecdc4',
                soundEffects: ['ignition']
            }
        };

        // Effets sonores supplémentaires
        const soundEffects = {
            turbo: { name: 'Turbo', icon: '💨', file: 'turbo.mp3' },
            exhaust: { name: 'Échappement', icon: '🔥', file: 'exhaust.mp3' },
            ignition: { name: 'Démarrage', icon: '🔑', file: 'ignition.mp3' },
            horn: { name: 'Klaxon', icon: '📢', file: 'horn.mp3' }
        };

        class SoundEngineCar {
            constructor() {
                this.currentVehicle = 'muscle';
                this.audioContext = null;
                this.oscillator = null;
                this.gainNode = null;
                this.isPlaying = false;
                this.rpm = 0;
                this.speed = 0;
                this.throttle = 0;
                this.gear = 0;
                this.animationFrame = null;
                this.mode = 'static';
                this.watchId = null;
                this.audioEnabled = true;
                this.isRecording = false;
                this.sessionStartTime = Date.now();
                this.sessionData = {
                    distance: 0,
                    maxSpeed: 0,
                    avgSpeed: 0,
                    speedSamples: 0,
                    startTime: Date.now(),
                    positions: []
                };
                this.stats = {
                    totalDistance: parseFloat(localStorage.getItem('totalDistance') || '0'),
                    totalTime: parseInt(localStorage.getItem('totalTime') || '0'),
                    streakDays: parseInt(localStorage.getItem('streakDays') || '0')
                };
                this.masterVolume = 0.5;
                this.effectsVolume = 0.7;
                this.hapticEnabled = false;
                this.autoGear = true;
                this.geolocationEnabled = true;
                this.activeSoundEffects = {};
                this.challenges = [
                    {
                        id: 'speed_constant',
                        name: 'Vitesse constante',
                        description: 'Maintenez 60 km/h pendant 30 secondes',
                        targetSpeed: 60,
                        duration: 30000,
                        tolerance: 5,
                        progress: 0,
                        active: false
                    },
                    {
                        id: 'acceleration',
                        name: 'Accélération',
                        description: 'Atteignez 100 km/h en moins de 10 secondes',
                        targetSpeed: 100,
                        duration: 10000,
                        tolerance: 0,
                        progress: 0,
                        active: false
                    }
                ];
                
                this.init();
            }
            
            init() {
                this.renderVehicles();
                this.createVisualizer();
                this.bindEvents();
                this.updateStatsUI();
                this.updateSessionTimer();
                this.animateVisualizer();
                
                // Démarrer le moteur par défaut
                setTimeout(() => {
                    this.selectVehicle('muscle');
                    this.playEngineSound();
                }, 500);
            }
            
            renderVehicles() {
                const container = document.getElementById('vehicleSelector');
                container.innerHTML = '';
                
                Object.entries(vehicles).forEach(([id, vehicle]) => {
                    const button = document.createElement('button');
                    button.className = 'vehicle-button' + (id === this.currentVehicle ? ' active' : '');
                    button.dataset.vehicle = id;
                    button.innerHTML = `
                        <span class="vehicle-icon">${vehicle.icon}</span>
                        <div class="vehicle-name">${vehicle.name}</div>
                        <div class="vehicle-specs">${vehicle.specs}</div>
                    `;
                    container.appendChild(button);
                });
            }
            
            createVisualizer() {
                const visualizer = document.getElementById('visualizer');
                visualizer.innerHTML = '';
                
                for (let i = 0; i < 60; i++) {
                    const wave = document.createElement('div');
                    wave.className = 'sound-wave';
                    wave.style.height = '5px';
                    visualizer.appendChild(wave);
                    
                    // Ajouter des particules pour l'effet sonore
                    if (i % 10 === 0) {
                        const particle = document.createElement('div');
                        particle.className = 'particle';
                        particle.style.left = `${i * 10}px`;
                        visualizer.appendChild(particle);
                    }
                }
            }
            
            bindEvents() {
                // Sélection du mode
                document.querySelectorAll('.mode-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const mode = e.currentTarget.dataset.mode;
                        this.setMode(mode);
                    });
                });
                
                // Sélection du véhicule
                document.getElementById('vehicleSelector').addEventListener('click', (e) => {
                    if (e.target.closest('.vehicle-button')) {
                        const button = e.target.closest('.vehicle-button');
                        const vehicle = button.dataset.vehicle;
                        this.selectVehicle(vehicle);
                    }
                });
                
                // Contrôle de l'accélérateur
                const throttleSlider = document.getElementById('throttleSlider');
                throttleSlider.addEventListener('input', (e) => {
                    this.throttle = parseInt(e.target.value);
                    document.getElementById('throttleValue').textContent = this.throttle;
                    this.calculateRPM();
                });
                
                // Toggle audio
                document.getElementById('audioToggle').addEventListener('click', () => {
                    this.audioEnabled = !this.audioEnabled;
                    const button = document.getElementById('audioToggle');
                    button.classList.toggle('active', this.audioEnabled);
                    button.querySelector('span').textContent = this.audioEnabled ? '🔊' : '🔈';
                    
                    if (this.audioEnabled && this.isPlaying) {
                        this.playEngineSound();
                    } else if (!this.audioEnabled && this.oscillator) {
                        this.stopEngineSound();
                    }
                    
                    this.showNotification(`Audio ${this.audioEnabled ? 'activé' : 'désactivé'}`);
                });
                
                // Toggle moteur
                document.getElementById('engineToggle').addEventListener('click', () => {
                    const button = document.getElementById('engineToggle');
                    
                    if (this.isPlaying) {
                        this.stopEngineSound();
                        button.querySelector('span').textContent = '▶️';
                        this.showNotification('Moteur arrêté');
                    } else {
                        this.playEngineSound();
                        button.querySelector('span').textContent = '⏸️';
                        this.showNotification('Moteur démarré');
                    }
                    
                    button.classList.toggle('active', this.isPlaying);
                });
                
                // Toggle thème
                document.getElementById('themeToggle').addEventListener('click', () => {
                    document.body.classList.toggle('theme-light');
                    const button = document.getElementById('themeToggle');
                    button.classList.toggle('active');
                    this.showNotification(`Thème ${document.body.classList.contains('theme-light') ? 'clair' : 'sombre'} activé`);
                });
                
                // Paramètres
                document.getElementById('settingsButton').addEventListener('click', () => {
                    document.getElementById('settingsModal').style.display = 'block';
                });
                
                document.getElementById('closeSettings').addEventListener('click', () => {
                    document.getElementById('settingsModal').style.display = 'none';
                });
                
                // Aide
                document.getElementById('helpButton').addEventListener('click', () => {
                    document.getElementById('helpModal').style.display = 'block';
                });
                
                document.getElementById('closeHelp').addEventListener('click', () => {
                    document.getElementById('helpModal').style.display = 'none';
                });
                
                // Volume principal
                document.getElementById('masterVolumeSlider').addEventListener('input', (e) => {
                    this.masterVolume = parseInt(e.target.value) / 100;
                    document.getElementById('masterVolumeLabel').textContent = `${e.target.value}%`;
                    
                    if (this.gainNode) {
                        this.gainNode.gain.value = this.audioEnabled ? this.masterVolume : 0;
                    }
                });
                
                // Volume des effets
                document.getElementById('effectsVolumeSlider').addEventListener('input', (e) => {
                    this.effectsVolume = parseInt(e.target.value) / 100;
                    document.getElementById('effectsVolumeLabel').textContent = `${e.target.value}%`;
                });
                
                // Géolocalisation
                document.getElementById('geolocationEnabled').addEventListener('change', (e) => {
                    this.geolocationEnabled = e.target.checked;
                    if (this.mode === 'driving' && this.geolocationEnabled) {
                        this.startGeolocation();
                    } else {
                        this.stopGeolocation();
                    }
                });
                
                // Boîte manuelle
                document.getElementById('autoGear').addEventListener('change', (e) => {
                    this.autoGear = e.target.checked;
                    this.gear = this.autoGear ? (this.throttle > 0 ? 1 : 0) : this.gear;
                    document.getElementById('gearDisplay').textContent = this.gear > 0 ? this.gear : 'N';
                });
                
                // Boutons de vitesse manuelle
                document.getElementById('gearUp').addEventListener('click', () => {
                    if (!this.autoGear && this.gear < 6) {
                        this.gear++;
                        document.getElementById('gearDisplay').textContent = this.gear;
                        this.showNotification(`Passage en vitesse ${this.gear}`);
                    }
                });
                
                document.getElementById('gearDown').addEventListener('click', () => {
                    if (!this.autoGear && this.gear > 0) {
                        this.gear--;
                        document.getElementById('gearDisplay').textContent = this.gear > 0 ? this.gear : 'N';
                        this.showNotification(this.gear > 0 ? `Passage en vitesse ${this.gear}` : 'Point mort');
                    }
                });
                
                // Effets sonores
                document.querySelectorAll('.sound-effect-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const effect = e.currentTarget.dataset.effect;
                        this.toggleSoundEffect(effect);
                    });
                });
                
                // Fermeture modale en cliquant en dehors
                window.addEventListener('click', (e) => {
                    if (e.target === document.getElementById('settingsModal')) {
                        document.getElementById('settingsModal').style.display = 'none';
                    }
                    if (e.target === document.getElementById('helpModal')) {
                        document.getElementById('helpModal').style.display = 'none';
                    }
                });
            }
            
            selectVehicle(vehicle) {
                this.currentVehicle = vehicle;
                this.renderVehicles();
                
                // Mettre à jour l'interface
                document.querySelectorAll('.vehicle-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-vehicle="${vehicle}"]`).classList.add('active');
                
                // Mettre à jour le son si en cours
                if (this.isPlaying) {
                    this.stopEngineSound();
                    this.playEngineSound();
                }
                
                // Réinitialiser les effets sonores
                document.querySelectorAll('.sound-effect-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Activer les effets par défaut du véhicule
                const vehicleData = vehicles[vehicle];
                vehicleData.soundEffects.forEach(effect => {
                    this.toggleSoundEffect(effect, true);
                });
                
                this.showNotification(`Véhicule sélectionné: ${vehicleData.name}`);
            }
            
            setMode(mode) {
                if (this.mode === mode) return;
                
                this.mode = mode;
                
                // Mettre à jour les boutons actifs
                document.querySelectorAll('.mode-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === mode);
                });
                
                // Gérer la géolocalisation
                if (mode === 'driving' && this.geolocationEnabled) {
                    this.startGeolocation();
                } else {
                    this.stopGeolocation();
                }
                
                // Gérer les défis
                if (mode === 'challenge') {
                    document.getElementById('challengePanel').style.display = 'block';
                    this.startChallenge(this.challenges[0]);
                } else {
                    document.getElementById('challengePanel').style.display = 'none';
                    this.stopChallenge();
                }
                
                // Adapter le comportement au mode
                if (mode === 'circuit') {
                    throttleSlider.value = 80;
                    this.throttle = 80;
                    document.getElementById('throttleValue').textContent = this.throttle;
                    this.calculateRPM();
                } else if (mode === 'static') {
                    throttleSlider.value = 0;
                    this.throttle = 0;
                    document.getElementById('throttleValue').textContent = this.throttle;
                    this.calculateRPM();
                }
                
                this.showNotification(`Mode ${mode} activé`);
            }
            
            startGeolocation() {
                if (!navigator.geolocation) {
                    this.showNotification('Géolocalisation non supportée par votre navigateur');
                    return;
                }
                
                this.watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        if (position.coords.speed !== null) {
                            this.speed = Math.round(position.coords.speed * 3.6); // Conversion m/s -> km/h
                            this.calculateRPM();
                            this.updateGauges();
                            
                            // Mettre à jour les statistiques de session
                            this.sessionData.distance += position.coords.speed * 0.1; // Distance en km
                            this.sessionData.speedSamples++;
                            this.sessionData.avgSpeed = (this.sessionData.avgSpeed * (this.sessionData.speedSamples - 1) + this.speed) / this.sessionData.speedSamples;
                            
                            document.getElementById('sessionDistance').textContent = this.sessionData.distance.toFixed(1);
                            document.getElementById('sessionAvgSpeed').textContent = Math.round(this.sessionData.avgSpeed);
                        }
                    },
                    (error) => {
                        let errorMessage = '';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Accès à la géolocalisation refusé';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Position indisponible';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Délai de localisation dépassé';
                                break;
                            default:
                                errorMessage = 'Erreur inconnue';
                        }
                        this.showNotification(`Erreur: ${errorMessage}`);
                    },
                    { 
                        enableHighAccuracy: true, 
                        maximumAge: 0, 
                        timeout: 5000 
                    }
                );
            }
            
            stopGeolocation() {
                if (this.watchId) {
                    navigator.geolocation.clearWatch(this.watchId);
                    this.watchId = null;
                }
            }
            
            calculateRPM() {
                const vehicle = vehicles[this.currentVehicle];
                
                if (this.mode === 'static') {
                    this.rpm = Math.round(this.throttle * vehicle.maxRpm / 100);
                    this.speed = Math.round(this.throttle * vehicle.maxSpeed / 100);
                } else if (this.mode === 'circuit') {
                    // Mode circuit - augmentation rapide du RPM
                    this.rpm = Math.min(vehicle.maxRpm, 3000 + this.throttle * (vehicle.maxRpm - 3000) / 100);
                    this.speed = Math.round(this.rpm * vehicle.maxSpeed / vehicle.maxRpm);
                } else {
                    // Mode conduite - RPM basé sur la vitesse
                    this.rpm = Math.min(vehicle.maxRpm, 1000 + this.speed * 40);
                }
                
                // Calcul automatique de la vitesse si nécessaire
                if (this.mode !== 'driving') {
                    this.speed = Math.round(this.rpm * vehicle.maxSpeed / vehicle.maxRpm);
                }
                
                // Mise à jour de la vitesse en fonction du rapport de boîte
                if (!this.autoGear && this.gear > 0) {
                    this.speed = Math.round(this.rpm * vehicle.maxSpeed / (vehicle.maxRpm * this.gear * 0.9));
                }
                
                this.updateGauges();
            }
            
            updateGauges() {
                const vehicle = vehicles[this.currentVehicle];
                
                // Mettre à jour les valeurs
                document.getElementById('rpmValue').textContent = this.rpm;
                document.getElementById('speedValue').textContent = this.speed;
                
                // Mettre à jour les jauges circulaires
                const rpmGauge = document.getElementById('rpmGauge');
                const speedGauge = document.getElementById('speedGauge');
                
                rpmGauge.style.background = `conic-gradient(from 0deg, #4ecdc4 0deg, #4ecdc4 ${this.rpm / vehicle.maxRpm * 360}deg, #333 ${this.rpm / vehicle.maxRpm * 360}deg)`;
                speedGauge.style.background = `conic-gradient(from 0deg, #ff6b6b 0deg, #ff6b6b ${this.speed / vehicle.maxSpeed * 360}deg, #333 ${this.speed / vehicle.maxSpeed * 360}deg)`;
                
                // Mettre à jour la vitesse
                if (this.autoGear) {
                    this.gear = this.throttle > 0 ? 1 : 0;
                }
                document.getElementById('gearDisplay').textContent = this.gear > 0 ? this.gear : 'N';
                
                // Mettre à jour le compteur de vitesse max
                if (this.speed > this.sessionData.maxSpeed) {
                    this.sessionData.maxSpeed = this.speed;
                    document.getElementById('sessionMaxSpeed').textContent = Math.round(this.sessionData.maxSpeed);
                }
            }
            
            animateVisualizer() {
                const waves = document.querySelectorAll('.sound-wave');
                const particles = document.querySelectorAll('.particle');
                
                const animate = () => {
                    const intensity = this.rpm / vehicles[this.currentVehicle].maxRpm;
                    
                    // Animer les vagues sonores
                    waves.forEach((wave, index) => {
                        const waveOffset = Math.sin(index * 0.3 + Date.now() * 0.005);
                        const height = 5 + Math.abs(waveOffset) * intensity * 40;
                        wave.style.height = `${Math.min(height, 80)}px`;
                        wave.style.background = `linear-gradient(to top, ${vehicles[this.currentVehicle].color}, #ffffff)`;
                    });
                    
                    // Animer les particules
                    particles.forEach(particle => {
                        particle.style.top = `${20 + Math.sin(Date.now() * 0.002 + parseInt(particle.style.left) * 0.01) * 30}px`;
                    });
                    
                    this.animationFrame = requestAnimationFrame(animate);
                };
                
                animate();
            }
            
            playEngineSound() {
                this.ensureAudioContext();
                
                // Arrêter le son précédent s'il existe
                this.stopEngineSound();
                
                const vehicle = vehicles[this.currentVehicle];
                
                // Créer l'oscillateur
                this.oscillator = this.audioContext.createOscillator();
                this.oscillator.type = vehicle.waveType;
                this.oscillator.frequency.value = vehicle.baseFreq;
                
                // Créer le contrôle de gain
                this.gainNode = this.audioContext.createGain();
                this.gainNode.gain.value = this.audioEnabled ? this.masterVolume : 0;
                
                // Connecter les nœuds
                this.oscillator.connect(this.gainNode);
                this.gainNode.connect(this.audioContext.destination);
                
                // Démarrer l'oscillateur
                this.oscillator.start();
                this.isPlaying = true;
                
                // Mettre à jour le son en fonction des RPM
                this.updateEngineSound();
            }
            
            updateEngineSound() {
                if (!this.oscillator || !this.isPlaying) return;
                
                const vehicle = vehicles[this.currentVehicle];
                const frequency = vehicle.baseFreq + (this.rpm * vehicle.freqFactor);
                
                // Mettre à jour la fréquence
                this.oscillator.frequency.linearRampToValueAtTime(
                    frequency, 
                    this.audioContext.currentTime + 0.1
                );
            }
            
            stopEngineSound() {
                if (this.oscillator) {
                    this.oscillator.stop();
                    this.oscillator = null;
                }
                this.isPlaying = false;
            }
            
            ensureAudioContext() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
            }
            
            toggleSoundEffect(effect, forceEnable = false) {
                const button = document.querySelector(`.sound-effect-btn[data-effect="${effect}"]`);
                
                if (this.activeSoundEffects[effect] && !forceEnable) {
                    // Désactiver l'effet
                    delete this.activeSoundEffects[effect];
                    button.classList.remove('active');
                    this.showNotification(`Effet désactivé: ${soundEffects[effect].name}`);
                } else {
                    // Activer l'effet
                    this.activeSoundEffects[effect] = true;
                    button.classList.add('active');
                    this.showNotification(`Effet activé: ${soundEffects[effect].name}`);
                    
                    // Jouer un son de feedback (simulation)
                    if (this.audioContext) {
                        this.playEffectSound(effect);
                    }
                }
            }
            
            playEffectSound(effect) {
                // Simulation de la lecture d'un effet sonore
                // En production, on chargerait un fichier audio réel
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                // Paramètres selon l'effet
                switch(effect) {
                    case 'turbo':
                        oscillator.type = 'sawtooth';
                        oscillator.frequency.setValueAtTime(100, this.audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(1000, this.audioContext.currentTime + 0.3);
                        break;
                    case 'exhaust':
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(80, this.audioContext.currentTime);
                        break;
                    case 'ignition':
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(50, this.audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(300, this.audioContext.currentTime + 0.5);
                        break;
                    case 'horn':
                        oscillator.type = 'square';
                        oscillator.frequency.setValueAtTime(400, this.audioContext.currentTime);
                        break;
                }
                
                gainNode.gain.value = this.effectsVolume;
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 1);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + 1);
            }
            
            startChallenge(challenge) {
                challenge.active = true;
                challenge.startTime = Date.now();
                document.getElementById('challengeTitle').textContent = challenge.name;
                document.getElementById('challengeDescription').textContent = challenge.description;
            }
            
            stopChallenge() {
                this.challenges.forEach(challenge => challenge.active = false);
            }
            
            updateSessionTimer() {
                const update = () => {
                    const elapsed = Math.floor((Date.now() - this.sessionStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    document.getElementById('sessionTime').textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                    
                    setTimeout(update, 1000);
                };
                
                update();
            }
            
            updateStatsUI() {
                document.getElementById('totalDistance').textContent = this.stats.totalDistance.toFixed(1);
                document.getElementById('totalTime').textContent = this.stats.totalTime;
                document.getElementById('streakDays').textContent = this.stats.streakDays;
            }
            
            showNotification(text) {
                const notification = document.getElementById('notification');
                notification.textContent = text;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        }
        
        // Initialiser l'application
        document.addEventListener('DOMContentLoaded', () => {
            window.soundApp = new SoundEngineCar();
        });
    </script>
</body>
</html>